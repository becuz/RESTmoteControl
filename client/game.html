<!DOCTYPE html>
<html>
<head>
<title>Baloonathon</title>
<script type="text/javascript" src="jquery-1.8.2.min.js"></script>
<script type="text/javascript">
	var beta = 0, gamma = 0, range = 100, frequency = 75, id = null, color = null, block = false;

	window.onclick = function() {
		if (block) return;
		
		if (id == null)
			$.getJSON('http://' + window.location.hostname + ':'
					+ window.location.port + '/api/baloon', function(data) {
				if (data == null)
					$('#info').text('All slots occupied!');

				console.log(data);

				id = data.index;
				color = data.colorS;
				document.body.style.backgroundColor = data.colorS;
			});
		else  {
			$.ajax({
				type : 'POST',
				url : 'http://' + window.location.hostname + ':'
						+ window.location.port + '/api/baloon/click/' + id
			});
			/* document.body.style.backgroundColor = "black";
			setTimeout(function() {
				document.body.style.backgroundColor = color;
			}, 150); */
		}
	}

	function installHandler() {
		if (window.DeviceOrientationEvent) {
			window.addEventListener('deviceorientation', function(e) {
				if (navigator.userAgent.indexOf("Firefox") != -1) {
					beta = e.beta;
					gamma = e.gamma;
				}
				else {
					beta = -e.beta;
					gamma = -e.gamma;
				}
				$('#info').text(beta + '° ' + gamma + '°');
			}, false);
		} else if (window.OrientationEvent) {
			window.addEventListener('MozOrientation', function(e) {
				beta = e.x * 90;
				gamma = e.y * -90;
				$('#info').text(beta + '° ' + gamma + '°');
			}, false);
		} else {
			$('#info').text('Orientation is not supported! :(');
			block = true;
			return;
		}

		window.setInterval(push, frequency);
	}

	function push() {
		if (id == null)
			return;

		beta = Math.abs(beta) < 3 ? 0 : parseInt(Math.round(beta));
		gamma = Math.abs(gamma) < 3 ? 0 : parseInt(Math.round(gamma));

		if (beta == 0 && gamma == 0)
			return;

		$.ajax({
			type : 'PUT',
			url : 'http://' + window.location.hostname + ':'
					+ window.location.port + '/api/baloon/pos/' + id + '/'
					+ map(-gamma) + 'x' + map(-beta)
		})
	}

	function map(angle) {
		var value = parseInt((angle + 90) * (2 * range) / 180 - range);
		return value >= 0 ? '+' + value : value;
	}
</script>
</head>
<body onload="installHandler();"
	style="text-align: center; padding: 5%;">
	<span style="font-family: monospace; font-size: 200%;" id="info">No
		data :(</span>
</body>
</html>
